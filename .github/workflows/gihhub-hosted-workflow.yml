name: Bootstrap & Deploy to EC2 using git hosted runner

# on:
#   push:
#     branches:
#       - main
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Bootstrap server and deploy app
        run: |
          ssh -i ~/.ssh/ec2_key \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            APP_DIR="/var/www/app"
            REPO_URL="https://github.com/shamssuny/ostd-github-cd-cd-2"

            echo "ðŸ”¹ Installing system dependencies"
            sudo apt update -y
            sudo apt install -y nginx git

            echo "ðŸ”¹ Enable & start nginx"
            sudo systemctl enable nginx
            sudo systemctl start nginx

            echo "ðŸ”¹ Clone or update repository"
            if [ ! -d "$APP_DIR/.git" ]; then
              sudo mkdir -p $APP_DIR
              sudo chown -R $USER:$USER /var/www
              git clone $REPO_URL $APP_DIR
            else
              cd $APP_DIR
              git fetch origin
              git reset --hard origin/main
            fi

            echo "ðŸ”¹ Configure nginx server block"

            cat <<NGINX | sudo tee /etc/nginx/sites-available/app > /dev/null
          server {
              listen 80;
              server_name _;

              root /var/www/app;
              index index.html;

              location / {
                  try_files \$uri \$uri/ =404;
              }
          }
          NGINX

            if [ ! -L /etc/nginx/sites-enabled/app ]; then
                sudo ln -s /etc/nginx/sites-available/app /etc/nginx/sites-enabled/app
            fi

            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl reload nginx
          EOF


      - name: Health check
        run: |
          curl -f http://${{ secrets.EC2_HOST }}
