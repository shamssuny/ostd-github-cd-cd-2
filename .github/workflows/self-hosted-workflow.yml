name: Bootstrap & Deploy to EC2 using self hosted runner (project and runner in same ec2)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:

      - name: Bootstrap server and deploy app
        run: |
          
          set -e

          APP_DIR="/var/www/app"
          REPO_URL="https://github.com/shamssuny/ostd-github-cd-cd-2"

          echo "ðŸ”¹ Installing system dependencies"
          sudo apt update -y
          sudo apt install -y nginx git

          echo "ðŸ”¹ Enable & start nginx"
          sudo systemctl enable nginx
          sudo systemctl start nginx

          echo "ðŸ”¹ Clone or update repository"
          if [ ! -d "$APP_DIR/.git" ]; then
            sudo mkdir -p $APP_DIR
            sudo chown -R $USER:$USER /var/www
            git clone $REPO_URL $APP_DIR
          else
            cd $APP_DIR
            git fetch origin
            git reset --hard origin/main
          fi

          echo "ðŸ”¹ Configure nginx server block"

          cat <<NGINX | sudo tee /etc/nginx/sites-available/app > /dev/null
          server {
              listen 80;
              server_name _;

              root /var/www/app;
              index index.html;

              location / {
                  try_files \$uri \$uri/ =404;
              }
          }
          NGINX

          if [ ! -L /etc/nginx/sites-enabled/app ]; then
              sudo ln -s /etc/nginx/sites-available/app /etc/nginx/sites-enabled/app
          fi

          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          sudo systemctl reload nginx
          


      - name: Health check
        run: |
          curl -f http://${{ secrets.EC2_HOST }}
